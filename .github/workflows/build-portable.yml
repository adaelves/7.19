name: Build Portable Applications

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      create_release:
        description: 'Create GitHub release'
        type: boolean
        default: true

jobs:
  build-portable:
    name: Build Portable App for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            artifact_name: VideoDownloader_Windows_Portable
            archive_format: zip
          - os: macos-latest
            platform: darwin
            artifact_name: VideoDownloader_macOS_Portable
            archive_format: zip
          - os: ubuntu-latest
            platform: linux
            artifact_name: VideoDownloader_Linux_Portable
            archive_format: tar.gz
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          libegl1-mesa \
          libxcb-cursor0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install PySide6 requests aiohttp yt-dlp
        
        # Install project dependencies if they exist
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
        if [ -f pyproject.toml ]; then
          pip install -e .
        fi
      shell: bash
    
    - name: Install optional tools (Ubuntu/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        # Try to install ffmpeg
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get install -y ffmpeg || echo "ffmpeg installation failed"
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install ffmpeg || echo "ffmpeg installation failed"
        fi
      shell: bash
    
    - name: Create version info
      run: |
        # Update version in build scripts
        sed -i.bak "s/VERSION = \"1.0.0\"/VERSION = \"${{ steps.version.outputs.version_number }}\"/g" build_scripts/pyinstaller_config.py
        sed -i.bak "s/app_version: str = \"1.0.0\"/app_version: str = \"${{ steps.version.outputs.version_number }}\"/g" app/core/config.py
      shell: bash
    
    - name: Create assets directory
      run: |
        mkdir -p assets
        # Create placeholder icon files
        touch assets/icon.ico assets/icon.icns assets/icon.png
    
    - name: Build portable application
      run: |
        python build_scripts/build_portable.py \
          --platform ${{ matrix.platform }} \
          --archive-format ${{ matrix.archive_format }} \
          --verbose
      env:
        PYTHONPATH: ${{ github.workspace }}
    
    - name: List build outputs
      run: |
        echo "Build directory contents:"
        ls -la portable/${{ matrix.platform }}/ || true
        echo "Archive files:"
        find portable/${{ matrix.platform }}/ -name "*.zip" -o -name "*.tar.gz" || true
      shell: bash
    
    - name: Find archive file
      id: find_archive
      run: |
        if [ "${{ matrix.archive_format }}" = "zip" ]; then
          ARCHIVE_FILE=$(find portable/${{ matrix.platform }}/ -name "*.zip" | head -1)
        else
          ARCHIVE_FILE=$(find portable/${{ matrix.platform }}/ -name "*.tar.gz" | head -1)
        fi
        
        if [ -n "$ARCHIVE_FILE" ] && [ -f "$ARCHIVE_FILE" ]; then
          echo "archive_path=$ARCHIVE_FILE" >> $GITHUB_OUTPUT
          echo "archive_name=$(basename $ARCHIVE_FILE)" >> $GITHUB_OUTPUT
          echo "Found archive: $ARCHIVE_FILE"
        else
          echo "No archive file found!"
          exit 1
        fi
      shell: bash
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ steps.find_archive.outputs.archive_path }}
        retention-days: 30
    
    - name: Upload to release
      if: github.event_name == 'push' || github.event.inputs.create_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: VideoDownloader ${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        files: ${{ steps.find_archive.outputs.archive_path }}
        body: |
          ## VideoDownloader ${{ steps.version.outputs.version }}
          
          ### ðŸŽ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          è¿™æ˜¯VideoDownloaderçš„ä¾¿æºç‰ˆæœ¬ï¼Œæ— éœ€å®‰è£…å³å¯ä½¿ç”¨ã€‚
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `VideoDownloader_*_Win64_Portable.zip`
          - **macOSç”¨æˆ·**: ä¸‹è½½ `VideoDownloader_*_macOS_Portable.zip`  
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `VideoDownloader_*_Linux64_Portable.tar.gz`
          
          ### ðŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œå¯åŠ¨è„šæœ¬ï¼š
             - Windows: åŒå‡» `VideoDownloader.bat`
             - macOS: åŒå‡» `Run_VideoDownloader.command`
             - Linux: è¿è¡Œ `./run_VideoDownloader.sh`
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          
          - ðŸŽ¬ æ”¯æŒå¤šå¹³å°è§†é¢‘ä¸‹è½½
          - ðŸ“± æ”¯æŒç¤¾äº¤åª’ä½“å¹³å°
          - ðŸ”„ æ‰¹é‡ä¸‹è½½å’Œç›‘æŽ§
          - ðŸŽ¨ çŽ°ä»£åŒ–UIç•Œé¢
          - ðŸ”Œ æ’ä»¶ç³»ç»Ÿæ”¯æŒ
          - ðŸ’¾ ä¾¿æºç‰ˆè®¾è®¡ï¼Œæ•°æ®æœ¬åœ°å­˜å‚¨
          
          ### ðŸ› ï¸ ç³»ç»Ÿè¦æ±‚
          
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **macOS**: macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬  
          - **Linux**: çŽ°ä»£Linuxå‘è¡Œç‰ˆ
          - **å†…å­˜**: 4GB RAM æœ€ä½Ž
          - **å­˜å‚¨**: 1GB å¯ç”¨ç©ºé—´
          - **ç½‘ç»œ**: äº’è”ç½‘è¿žæŽ¥
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢åé¦ˆã€‚
          
          ### ðŸ“ æ›´æ–°æ—¥å¿—
          
          - æ–°å¢žä¾¿æºç‰ˆæ”¯æŒ
          - ä¼˜åŒ–è·¨å¹³å°å…¼å®¹æ€§
          - æ”¹è¿›ç”¨æˆ·ç•Œé¢
          - ä¿®å¤å·²çŸ¥é—®é¢˜
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-checksums:
    name: Create Checksums
    needs: build-portable
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts/
    
    - name: Create checksums
      run: |
        cd artifacts/
        find . -name "*.zip" -o -name "*.tar.gz" | while read file; do
          echo "Creating checksum for: $file"
          sha256sum "$file" >> checksums.txt
        done
        
        echo "Checksums created:"
        cat checksums.txt
    
    - name: Upload checksums to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        files: artifacts/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}